---
import Layout from "../layouts/Layout.astro";
import ArticleCarousel from "../components/ArticleCarousel.astro";
import EventCarousel from "../components/EventCarousel.astro";
import { mapMeetupsToCards } from "../utils/mapMeetupsToCards";
import { mapPostsToCards } from "../utils/mapPostsToCards";

const meetupData = await fetch(`${import.meta.env.PUBLIC_GRAPHQL_ENDPOINT}`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: `
    {
      posts(where: {categoryName: "meetups"}) {
        nodes {
          id: databaseId
          slug
          title(format: RENDERED)
          eventSettings {
            eventDate
          }
          featuredImage {
            node {
              mediaDetails {
                sizes(include: MEDIUM) {
                  height
                  width
                  sourceUrl
                }
              }
            }
          }
        }
      }
    }
    `,
  }),
});

const blogData = await fetch(`${import.meta.env.PUBLIC_GRAPHQL_ENDPOINT}`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: `
      {
      posts(where: {categoryName: "blog"}) {
        nodes {
          id: databaseId
          slug
          title(format: RENDERED)
          date
          featuredImage {
            node {
              mediaDetails {
                sizes(include: MEDIUM) {
                  height
                  width
                  sourceUrl
                }
              }
            }
          }
        }
      }
      }
    `,
  }),
});

const meetupJson = await meetupData.json();
const meetupPosts = meetupJson.data.posts.nodes;
const meetupCards = mapMeetupsToCards(meetupPosts);

const blogJson = await blogData.json();
const blogPosts = blogJson.data.posts.nodes;
const blogCards = mapPostsToCards(blogPosts);
---

<Layout title="Slow dating Berlin">
  {
    meetupCards.length > 0 && (
      <EventCarousel title="Events" cards={meetupCards} />
    )
  }
  {
    blogCards.length > 0 && (
      <ArticleCarousel title="News & Community" cards={blogCards} />
    )
  }
</Layout>
