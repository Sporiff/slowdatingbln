---
import Layout from "../layouts/Layout.astro";
import ArticleCarousel from "../components/ArticleCarousel.astro";
import EventCarousel from "../components/EventCarousel.astro";
import type { CardProps } from "../components/Card.astro";
import { postDateToDateString } from "../utils/postDateToDateString";

interface ApiResponse {
  id: number;
  slug: string;
  title: string;
  eventSettings?: {
    eventDate?: string;
  };
  featuredImage: {
    node: {
      mediaDetails: {
        sizes: [
          {
            height: number;
            width: number;
            sourceUrl: string;
          },
        ];
      };
    };
  };
}

const mapApiResponseToCardProps = (apiResponse: ApiResponse[]): CardProps[] => {
  return apiResponse.map((response) => ({
    imageSrc: response.featuredImage.node.mediaDetails.sizes[0].sourceUrl,
    heading: response.title,
    body: response.title,
    href: `/events/${response.slug}`,
    date: response.eventSettings!.eventDate
      ? postDateToDateString(response.eventSettings!.eventDate)
      : "",
    height: response.featuredImage.node.mediaDetails.sizes[0].height,
    width: response.featuredImage.node.mediaDetails.sizes[0].width,
  }));
};

const meetupData = await fetch(`${import.meta.env.PUBLIC_GRAPHQL_ENDPOINT}`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: `
    {
      posts(where: {categoryName: "meetups"}) {
        nodes {
          id: databaseId
          slug
          title(format: RENDERED)
          eventSettings {
            eventDate
          }
          featuredImage {
            node {
              mediaDetails {
                sizes(include: MEDIUM) {
                  height
                  width
                  sourceUrl
                }
              }
            }
          }
        }
      }
    }
    `,
  }),
});

const blogData = await fetch(`${import.meta.env.PUBLIC_GRAPHQL_ENDPOINT}`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: `
      {
      posts(where: {categoryName: "blog"}) {
        nodes {
          id: databaseId
          slug
          title(format: RENDERED)
          featuredImage {
            node {
              mediaItemUrl
              mediaDetails {
                height
                width
              }
            }
          }
        }
      }
      }
    `,
  }),
});

const meetupJson = await meetupData.json();
const meetupPosts = meetupJson.data.posts.nodes;
const meetupCards = mapApiResponseToCardProps(meetupPosts);

const blogJson = await blogData.json();
const blogPosts = blogJson.data.posts.nodes;
const blogCards = mapApiResponseToCardProps(blogPosts);
---

<Layout title="Slow dating Berlin">
  {
    meetupCards.length > 0 && (
      <EventCarousel title="Events" cards={meetupCards} />
    )
  }
  {
    blogCards.length > 0 && (
      <ArticleCarousel title="News & Community" cards={blogCards} />
    )
  }
</Layout>
